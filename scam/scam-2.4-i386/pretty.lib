(define __pretty-indent "    ")

(define (pretty expr)
    (prettyIndented expr "")
    )

(define (prettyIndent str)
    (if (valid? str) (print str))
    )

(define (prettyIndented expr indent)
    (define (ppTestBlock expr indent)
        (prettyIndent indent)
        (print "(" (car expr) " " (cadr expr) "\n")
        (ppCodeList (cddr expr) (string+ indent __pretty-indent))
        (prettyIndent indent)
        (print __pretty-indent ")\n")
        )
    (define (ppBlock expr indent)
        (prettyIndent indent)
        (print "(" (car expr) "\n")
        (ppCodeList (cdr expr) (string+ indent __pretty-indent))
        (prettyIndent indent)
        (print __pretty-indent ")\n")
        )
    (define (ppFunction expr indent)
        (define p)
        (prettyIndent indent)
        (print "(define ("(dot expr name))
        (for-all p (dot expr parameters)
            (print " " p)
            )
        (print ")\n")
        (ppCodeList (cdr (dot expr code)) (string+ indent __pretty-indent))
        (prettyIndent indent)
        (print __pretty-indent ")\n")
        )
    (define (ppFunctionDefinition expr indent)
        (define p)
        (println indent "(define " (cadr expr))
        (ppCodeList (cddr expr) (string+ indent __pretty-indent))
        (prettyIndent indent)
        (print __pretty-indent ")\n")
        )

    (define (ppCodeList expr indent)
        (while (valid? expr)
            (if (prettyIndented (car expr) indent)
                (println)
                )
            (set 'expr (cdr expr))
            )
        )

    (define (ppCond expr indent)
        (define c)
        (prettyIndent indent)
        (print "(cond\n")
        (for-all c (cdr expr)
            (prettyIndent indent)
            (print __pretty-indent "(" (car c) "\n")
            (ppCodeList (cdr c) (string+ indent "        "))
            (prettyIndent indent)
            (print __pretty-indent __pretty-indent ")\n")
            )
        (prettyIndent indent)
        (print __pretty-indent ")\n")
        )

    ;;;;; end of helper functions ;;;;

    (cond
        ((null? expr)
            (prettyIndent indent)
            (print "nil")
            #t)
        ((not (pair? expr))
            (prettyIndent indent)
            (print expr)
            #t)
        ((closure? expr) (ppFunction expr indent) #f)
        ((eq? (car expr) 'begin) (ppBlock expr indent) #f)
        ((eq? (car expr) 'scope) (ppBlock expr indent) #f)
        ((eq? (car expr) 'cond) (ppCond expr indent) #f)
        ((eq? (car expr) 'if) (ppTestBlock expr indent) #f)
        ((eq? (car expr) 'while) (ppTestBlock expr indent) #f)
        ((eq? (car expr) 'let) (ppTestBlock expr indent) #f)
        ((and (eq? (car expr) 'define) (pair? (cadr expr)))
            (ppFunctionDefinition expr indent) #f)
        (else (print indent expr) #t)
        )
    )

(define (compile-pretty #)
    (include "compile.lib")
    (compile pretty #)
    (compile prettyIndented #)
    )
